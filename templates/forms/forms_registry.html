{% extends 'base.html' %}

{% load app_filters %}

{% load staticfiles %}

{% block page_title %} Forms Registry {% endblock %}

{% block style_code %}
<link href="{% static 'css/bootstrap-table.min.css' %}" rel="stylesheet" />
{% endblock %}

{% block javascript_code%}
{% endblock javascript_code%}

{% block primary %}
<!-- begin breadcrumb -->
<ol class="breadcrumb pull-right">
    <li><a href="#">Home</a></li>
    <li class="active">Forms</li>
</ol>
<!-- end breadcrumb -->

{% if messages %}
<div id="messages" class="alert alert-success fade in">
    <span class="close" data-dismiss="alert">×</span>
    <i class="fa fa-check fa-2x pull-left"></i>
    <ul class="messages">
        {% for message in messages %}
        <li{% if message.info %} class="{{ message.info }}"{% endif %}><b>{{ message }}</b></li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<!-- begin page-header -->
<h1 class="page-header">Forms <small>Search Forms</small></h1>
<!-- end page-header -->
<div id="messages" class="alert alert-danger fade in" style="display: none;" tabindex="1">
    <span class="close" data-dismiss="alert">×</span>
    <i class="fa fa-check fa-2x pull-left"></i>
    <p class="invalid-form-message"></p>
</div>

<!-- Search Row -->
<div class="row">
<!-- begin col-12 -->
<div class="col-md-12">
<!-- begin panel -->
<div class="panel panel-inverse">
    <div class="panel-heading">
        <div class="panel-heading-btn">
                <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-default" data-click="panel-expand"><i class="fa fa-expand"></i></a>
                <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-warning" data-click="panel-collapse"><i class="fa fa-minus"></i></a>
        </div>                          
        <h4 class="panel-title"><b>Search Forms</b></h4>
    </div>
    <div class="panel-body">
        <form class="form-inline" action="{% url 'forms_registry' %}" method="POST"  data-parsley-validate="true">
           {% csrf_token %}
            <div class="form-group m-r-10">
                <b>{{ form.form_type }}</b>
            </div>
            <div class="form-group m-r-10">
                <b>{{ form.form_person }}</b>
            </div>
            <button type="submit" class="btn btn-sm btn-primary m-r-5"><i class="fa fa-search"></i>&nbsp<b>Search</b></button>
        </form>
    </div>       
</div>

<!-- Form Results Row -->
<div class="row">        
    <div class="col-md-12">
        <!-- begin panel -->
        <div class="panel panel-inverse">
            <div class="panel-heading"> 
                <div class="panel-heading-btn">
                        <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-default" data-click="panel-expand"><i class="fa fa-expand"></i></a>
                        <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-warning" data-click="panel-collapse"><i class="fa fa-minus"></i></a>
                </div>                           
                <h4 class="panel-title"><b>Forms List &nbsp &nbsp<i class="fa fa-navicon"></i></b></h4>
            </div>

            {% if resultsets %}
            <div class="panel-body">
                <div class="table-responsive">
                    <table id="form-data-table" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Form ID</th>
                                <th>Serial</th>
                                <th>Person ID</th>
                                <th>Firstname</th>
                                <th>Surname</th>
                                <th>Sex</th>
                                <!--<th>Org Unit</th>-->
                                <th>Date Created</th>                                
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for resultset in resultsets %}
                                {% for results in resultset %}
                                <tr>
                                    <td>{{results.id}}</td>
                                    <td>{{results.form_id}}</td>
                                    {% for case in results.case_record %}
                                        <td>{{ case.case_serial }}</td>
                                    {% endfor %}
                                    {% for p in results.persons %}
                                        <td>{{ p.id }}</td>
                                        <td>{{ p.first_name }}</td>
                                        <td>{{ p.surname }}</td>
                                        <td>{{ p.sex_id|gen_value:vals }}</td>
                                    {% endfor %}

                                    <!--
                                    {% for orgu in results.orgunit %}
                                        <td>{{ orgu.org_unit_name }}</td>
                                    {% endfor %}
                                    -->

                                    <td>{{results.timestamp_created}}</td>
                                    
                                    <td>
                                    <a href="#" class="btn  btn-sm btn-primary m-r-5" data-toggle="modal" onClick="window.location.href='{% url 'view_case_record_sheet' id=results.form_id %}'">
                                    <b>View</b>&nbsp&nbsp<i class="fa fa-binoculars"></i></a>
                                    
                                    <a href="#" class="btn  btn-sm btn-primary m-r-5" data-toggle="modal" onClick="window.location.href='{% url 'edit_case_record_sheet' id=results.form_id %}'">
                                    <b>Edit</b>&nbsp&nbsp<i class="fa fa-edit"></i></a>
                                    
                                   <a href="#" class="btn  btn-sm btn-primary m-r-5" data-toggle="modal" onClick="window.location.href='{% url 'case_events' id=results.form_id %}'">
                                    <b>Follow-up</b>&nbsp&nbsp<i class="fa fa-paw"></i></a> 
                                     <!--<a href="#" class="btn  btn-sm btn-primary m-r-5" data-toggle="modal">
                                    <b>Follow-up</b>&nbsp&nbsp<i class="fa fa-paw"></i></a>-->
                                    

                                    <a href="#delete-dialog" class="btn  btn-sm btn-danger m-r-5" data-toggle="modal">
                                    <b>Delete</b>&nbsp&nbsp<i class="fa fa-trash"></i></a>
                                    </td>
                                </tr>
                                <!-- #modal-dialog -->
                                <div class="modal fade" id="delete-dialog">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                <h4 class="modal-title">Confirm Delete</h4>
                                            </div>
                                            <div class="modal-body">
                                                Do you want to delete {{ result.form_id }}?
                                            </div>
                                            <div class="modal-footer">
                                                <button class="btn btn-sm btn-white" data-dismiss="modal">No</button>
                                                <button class="btn btn-sm btn-success" onClick="window.location.href='{% url 'delete_case_record_sheet' id=results.form_id %}'">Yes</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- #modal-dialog -->
                                {% endfor %}
                            {% endfor %}


                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
                <div class="norecords" align="center"><b>No records found.</b></div>
            {% endif %}
                
        </div>
        <!-- end panel -->        
            
    </div>
</div>
<!-- End Form Results Row -->

</div>

<!-- End content area -->
{% endblock %}

{% block lazy_javascript_code %}
<script src="/static/plugins/parsley/dist/parsley.js"></script>
<script src="{% static 'js/bootstrap-table.min.js' %}"></script>
<script src="{% static 'js/bootstrap-table-locale-all.min.js' %}"></script>
<script type="text/javascript">
$('#form-data-table').bootstrapTable(
    { 
        toggle: 'table', 
        search: 'true',
        locale: 'en-US',
        pagination: 'true',
        pageNumber: 1,
        pageSize: 5,
        //showRefresh: true,
        showToggle: true,
        //showColumns: true,
        singleSelect: true,
        clickToSelect:true,
        maintainSelected: true,
        
        onClickRow: function (row, $element)
        {
            person_id = row[3];
            pfirst_name = row[4];
            psurname = row[5];
            localStorage.setItem("pfirst_name",pfirst_name);
            localStorage.setItem("psurname",psurname);
            localStorage.setItem("person_id",person_id);
        }        
    });
</script>
{% endblock %}

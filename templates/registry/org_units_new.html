{% extends 'base.html' %}
{% load staticfiles %}
{% block page_title %} Dashboard {% endblock %}

{% load crispy_forms_tags %}

{% block style_code %}
<link href="{% static 'plugins/parsley/src/parsley.css' %}" rel="stylesheet" />
<link href="{% static 'plugins/bootstrap-datepicker/css/datepicker3.css' %}" rel="stylesheet" />
<link href="{% static 'plugins/bootstrap-wizard/css/bwizard.min.css' %}" rel="stylesheet" />
<link href="{% static 'plugins/bootstrap-multiselect/dist/css/bootstrap-multiselect.css' %}" rel="stylesheet">

{% endblock %}

{% block primary %}
<!-- begin breadcrumb -->
<ol class="breadcrumb pull-right">
	<li><a href="#">Home</a></li>
	<li class="active">Registry</li>
</ol>
<!-- end breadcrumb -->
<!-- begin page-header -->
<h1 class="page-header">Registry <small>Register Organisational Unit</small></h1>
<!-- end page-header -->
<div id="messages" class="alert alert-danger fade in" style="display: none;" tabindex="1">
    <span class="close" data-dismiss="alert">Ã—</span>
    <i class="fa fa-check fa-2x pull-left"></i>
    <p class="invalid-form-message"></p>
</div>
<!-- begin row -->
<div class="row">
    <!-- begin col-12 -->
    <div class="col-md-12">
        <!-- begin panel -->
        <div class="panel panel-inverse">
            <div class="panel-heading">
                <div class="panel-heading-btn">
                    <a href="#" class="btn btn-xs btn-icon btn-circle btn-warning" data-click="panel-collapse"><i class="fa fa-minus"></i></a>
                    <a href="#" class="btn btn-xs btn-icon btn-circle btn-danger" data-click="panel-remove"><i class="fa fa-times"></i></a>
                </div>
                <h4 class="panel-title">Organization Unit details</h4>
            </div>
            <div class="panel-body">
                <form class="form-horizontal form-bordered" action="." method="POST" data-parsley-validate="true" name="form-wizard" id="new_org_unit">
					<div id="wizard">
						<ol>
							<li>
							    About the Organisation 
							    <small>Name and registration date.</small>
							</li>
							<li>
							    Organisation Type
							    <small>Organisation type and registration details.</small>
							</li>
							<li>
							    Location
							    <small>Where located / Providing services.</small>
							</li>
							<li>
							    Contact
							    <small>Organisation Unit contact details.</small>
							</li>
						</ol>
						<!-- begin wizard step-1 -->
						<div class="wizard-step-1">
                            <fieldset>
                                <legend class="pull-left width-full">About the Organisation</legend>
                                <div class="row">
                                    <div class="form-group">
										<label class="control-label col-md-4 col-sm-4" for="org_unit_name">Name of Organisation Unit * :</label>
										<div class="col-md-6 col-sm-6">
												{{ form.org_unit_name }}
										</div>
										<a href="#" data-toggle="tooltip" title="Unit name is mandatory"><i class="fa fa-info-circle fa-lg"></i></a>
									</div>
									<div class="form-group">
										<label class="control-label col-md-4 col-sm-4" for="date_reg">Date when the organisation Unit was set up or became operational:</label>
										<div class="col-md-6 col-sm-6">
			                                {{ form.reg_date }}
										</div>
										<a href="#" data-toggle="tooltip" title="This date is not mandatory"><i class="fa fa-info-circle fa-lg"></i></a>
									</div>
                                </div>
                                <!-- end row -->
							</fieldset>
						</div>
						<!-- end wizard step-1 -->
						<!-- begin wizard step-2 -->
						<div class="wizard-step-2">
							<fieldset>
								<legend class="pull-left width-full">Organisation Type</legend>
                                <!-- begin row -->
                                <div class="row">
                                    <!-- begin col-6 -->
                                    <div class="form-group">
										<label class="control-label col-md-4 col-sm-4" for="org_unit_type">Type of organisation Unit :</label>
										<div class="col-md-6 col-sm-6">
											{{ form.org_unit_type }}
										</div>
										<a href="#" data-toggle="tooltip" title="Type is mandatory"><i class="fa fa-info-circle fa-lg"></i></a>
									</div>
									<div class="form-group">
										<label class="control-label col-md-4 col-sm-4" for="legal_reg_type">Legal Registration type :</label>
										<div class="col-md-6 col-sm-6">
											{{ form.org_reg_type }}
										</div>
										<a href="#" data-toggle="tooltip" title="This is mandatory for NGO's"><i class="fa fa-info-circle fa-lg"></i></a>
									</div>
									<div class="form-group">
										<label class="control-label col-md-4 col-sm-4" for="legal_reg_number">Legal Registration Number :</label>
										<div class="col-md-6 col-sm-6">
											{{ form.legal_reg_number }}
										</div>
										<a href="#" data-toggle="tooltip" title="This is mandatory for NGO's"><i class="fa fa-info-circle fa-lg"></i></a>
									</div>
			                        <div class="form-group">
										<label class="control-label col-md-4 col-sm-4" for="parent_unit">Parent Unit :</label>
										<div class="col-md-6 col-sm-6">
											{{ form.parent_org_unit }}
										</div>
										<a href="#" data-toggle="tooltip" title="This is mandatory except for National level organisations."><i class="fa fa-info-circle fa-lg"></i></a>
									</div>
                                    <!-- end col-6 -->
                                </div>
                                <!-- end row -->
							</fieldset>
						</div>
						<!-- end wizard step-2 -->
						<!-- begin wizard step-3 -->
						<div class="wizard-step-3">
							<fieldset>
								<legend class="pull-left width-full">Location</legend>
                                <!-- begin row -->
                                <div class="row">
                                    <!-- begin col-4 -->
                                    <div class="form-group">
										<label class="control-label col-md-4 col-sm-4" for="sub_county">County :</label>
										<div class="col-md-4 col-sm-4">
											{{ form.county }}
											<br>
											<span id="sel_county" class="showlist"></span>
										</div>
										<a href="#" data-toggle="tooltip" title="This is not mandatory and will not be saved. Only used for filtering sub-counties."><i class="fa fa-info-circle fa-lg"></i></a>
									</div>
                                    <div class="form-group">
										<label class="control-label col-md-4 col-sm-4" for="sub_county">Sub County :</label>
										<div class="col-md-4 col-sm-4">
											{{ form.sub_county }}
											<br>
											<span id="sel_sub_county" class="showlist"></span>
										</div>
										<a href="#" data-toggle="tooltip" title="This is mandatory for some organisational units."><i class="fa fa-info-circle fa-lg"></i></a>
									</div>
									<div class="form-group">
										<label class="control-label col-md-4 col-sm-4" for="wards">Wards :</label>
										<div class="col-md-4 col-sm-4">
											{{ form.ward }}
											<br>
											<span id="sel_ward" class="showlist"></span>
										</div>
										<a href="#" data-toggle="tooltip" title="This is mandatory for some organisational units."><i class="fa fa-info-circle fa-lg"></i></a>
									</div>
			                        <!-- end col-6 -->
                                </div>
                                <!-- end row -->
                            </fieldset>
						</div>
						<!-- end wizard step-3 -->
						<!-- begin wizard step-4 -->
					    <div class="wizard-step-4">
						    <fieldset>
								<legend class="pull-left width-full">Contacts</legend>
                                <!-- begin row -->
                                <div class="row">
	                                    {% crispy cform %}
                                </div>
                                <!-- end row -->
                            </fieldset>
                        </div>
						<!-- end wizard step-4 -->
					</div>
					<!-- begin panel -->
	                <div class="panel panel-inverse" data-sortable-id="form-validation-1">
	                    <div class="panel-body panel-form">
							<div class="form-group">
								<label class="control-label col-md-4 col-sm-4"></label>
								<div class="col-md-6 col-sm-6">
								    <p></p>
									<button id="mysubmit" type="submit" class="btn btn-primary">Submit</button>
									<button type="submit" class="btn btn-default">Cancel</button>
									<p></p>
								</div>
							</div>
	                    </div>
	                </div>
				</form>
            </div>
        </div>
        <!-- end panel -->
    </div>
    <!-- end col-12 -->
</div>
<!-- end row -->
<!-- End content area -->
{% endblock %}

{% block lazy_javascript_code %}
	<script src="{% static 'plugins/bootstrap-wizard/js/bwizard.js' %}"></script>
	<script src="{% static 'js/form-wizards.js' %}"></script>
	<script src="{% static 'plugins/bootstrap-multiselect/dist/js/bootstrap-multiselect.js' %}"></script>
	<script type="text/javascript">
	    var parsleyInstance = $("#id_sub_county").parsley();
	    window.Parsley
		  .addValidator('chkcounty', {
		    requirementType: 'string',
		    validateMultiple: function(value, requirement) {
		      var refs = $(requirement).val();
		      var reff = $(requirement);
		      var vals = ["TNRL", "TNRR", "TNRC", "TNCB", "TNCM",
		                  "TNGS", "TNND", "TNAC", "TNCD", "TNGD"];
		      var cat1 = ["TNRL", "TNRR", "TNRC", "TNCB"];
		      var cat2 = ["TNCM", "TNGS", "TNND", "TNAC"];
		      var cat3 = ["TNCD", "TNGD"];
		      var cat4 = ["TNNM", "TNCP", "TNGB"];
		      var cat5 = ["TNNH", "TNCN", "TNGN"];

		      var msg = 'Please select a Sub-county';

		      if (reff.length){
                if (value){
                	if($.inArray(refs, vals) > -1){
	                	msg = 'Only one Sub-county required.';
	                	window.ParsleyValidator.addMessage('en', 'chkcounty',  msg);
	                	if (value.length == 1) return true; else return false;
	                }else if($.inArray(refs, cat4) > -1){
	                	msg = 'One or more Sub-county required.';
	                	window.ParsleyValidator.addMessage('en', 'chkcounty',  msg);
	                	if (value.length >= 1) return true; else return false;
	                }else if($.inArray(refs, cat5) > -1){
	                	msg = 'Sub-county not required';
	                	window.ParsleyValidator.addMessage('en', 'chkcounty',  msg);
	                	if (value.length == 0) return true; else return false;
	                }else{
	                	return true;
	                }
                }else{
                	window.ParsleyValidator.addMessage('en', 'chkcounty',  msg);
		      	    return false;
		        }
		      }else{
		      	window.ParsleyValidator.addMessage('en', 'chkcounty',  msg);
		      	return false;
		      }
		      //window.ParsleyValidator.addMessage('en', 'chkcounty',  msg);
		      //window.ParsleyValidator.catalog.en.chkcounty = msg;
		      //var parsleyInstance = $("#id_sub_county").parsley();
		      //window.ParsleyUI.updateError(parsleyInstance, 'chkcounty', 'error');
		    },
		    messages: {
		      en: 'One / more or no Sub-County is required.'
		    }
		 });
		window.Parsley
		  .addValidator('isngo', {
		    requirementType: 'string',
		    validateString: function(value, requirement) {
		      var refs = $(requirement).val();
		      var reff = $(requirement);
		      var vals = ["TNND", "TNNM", "TNNH"];
		      if (reff.length){
                if($.inArray(refs, vals) > -1){
                	if (value != '') return true; else return false;
                }else{
                	return true;
                }
		      }else{
		      	return false;
		      }
		    },
		    messages: {
		      en: 'Registration details should be provided for this unit.'
		    }
		  });
		window.Parsley
		    .addValidator('ishq', {
		    requirementType: 'string',
		    validateString: function(value, requirement) {
		      var refs = $(requirement).val();
		      var reff = $(requirement);
		      if (reff.length){
                if(refs != 'TNGN'){
                	if (value != '') return true; else return false;
                }else{
                	return true;
                }
		      }else{
		      	return false;
		      }
		    },
		    messages: {
		      en: 'Parent organization unit must be provided.'
		    }
		  });

		  window.Parsley
		    .addValidator('notfuturedate', {
		    requirementType: 'string',
		    validateString: function(fieldValue, fieldFormat) {
	            try {
	                var form_date = $.datepicker.parseDate(fieldFormat, fieldValue); 
	            } catch (e) {
	                return false;
	            }
	            var todate = new Date(); // today
	            return (form_date <= todate);
		    },
		    messages: {
		      en: 'Please provide a valid date that is not in the future.'
		    }
		  });

		  window.Parsley
		    .addValidator('checkuniq', {
		    requirementType: 'string',
		    validateString: function(fieldValue, fieldFormat) {
		    	var valid = false;
		        $.ajax({
		            url: '/registry/lookup/',
		            data: {'param': fieldValue, 'action': 3},
		            async: false,
		            success: function(response) {
		                if(response.counts > 0) {
		                    valid = false;
		                } else {
		                    valid = true;
		                }
		            },
                        error: function() {
                            valid = false;
                        }
		        });
		        return valid;
		    },
		    messages: {
		      en: 'Organisation unit with this name already exists.'
		    }
		  });

		 window.Parsley
		    .addAsyncValidator('checkunit', function (xhr) {
			    var response = xhr.responseText;
			    if (response.valid === true) {
			        return true;
			    } else {
			        return false;
			    }
			}, '/registry/lookup/');
	        
		</script>
	<script>
		jQuery(document).ready(function() {
			// $("#id_org_unit_name").parsley({ errorMessage: "User name already used" });
			$('html,body').scrollTop(0);
			FormWizardValidation.init();
			$('#id_county, #id_sub_county, #id_ward').multiselect({
				enableFiltering: true,
				filterBehavior: 'both',
				numberDisplayed: 0,
				maxHeight: 200,
				buttonWidth: '100%',
				disableIfEmpty: true,
				enableClickableOptGroups: true,
				enableCaseInsensitiveFiltering: true
			});
			$("#id_sub_county").change(function(e) {
				var county = $("#id_county").val();
				var sub_county = $("#id_sub_county").val();
				var ward = $("#id_ward").val();
		        var csrftoken = $.cookie('csrftoken');
                var values = {'sub_county': sub_county,
                              'county': county,
                              'ward': ward, 'action': 1,
                              'csrfmiddlewaretoken': csrftoken };
                $('#id_ward').empty();
				$.ajax({
					type: "POST",
					data: values,
					dataType: "json",
					url: "{% url 'reg_lookup' %}",
					success: function(data){
						var wards = data.wards;
						//$('#id_ward').html("<option value=''>Select One</option>");			
						$.each(wards, function(i, record) {
							var ward_attribs = wards[i].split(",");
                            $('#id_ward')
			            		.append($("<option></option>")
			            		.attr("value", ward_attribs[0])
			            		.text(ward_attribs[1]));
                         });
						var selects = data.selects;
						$.each(selects.split(","), function(i,e){
						    $("#id_ward option[value='" + e + "']").prop("selected", true);
						});
						$('#id_ward').multiselect('rebuild');
					},
			        error: function(){
			        	$('#messages').html("Error")
			        }
		        });
            });
            $("#id_county").change(function(e) {
				var county = $("#id_county").val();
				var sub_county = $("#id_sub_county").val();
				var ward = $("#id_ward").val();
		        var csrftoken = $.cookie('csrftoken');
                var values = {'sub_county': sub_county, 'ward': ward,
                              'county': county, 'action': 2,
                              'csrfmiddlewaretoken': csrftoken };
                $('#id_sub_county').empty();
				$.ajax({
					type: "POST",
					data: values,
					dataType: "json",
					url: "{% url 'reg_lookup' %}",
					success: function(data){
						var wards = data.wards;
						//$('#id_sub_county').html("<option value=''>Select One</option>");			
						$.each(wards, function(i, record) {
							var ward_attribs = wards[i].split(",");
                            $('#id_sub_county')
			            		.append($("<option></option>")
			            		.attr("value", ward_attribs[0])
			            		.text(ward_attribs[1]));
                         });
						var selects = data.selects;
						$.each(selects.split(","), function(i,e){
						    $("#id_sub_county option[value='" + e + "']").prop("selected", true);
						});
						$('#id_sub_county').multiselect('rebuild');
					},
			        error: function(){
			        	$('#messages').html("Error")
			        }
		        });
            });

		});
	</script>

    <script type="text/javascript">
		$(function () {
		  $('#new_org_unit').parsley().on('form:validate', function (formInstance) {
		    var ok = formInstance.isValid('primary', true) || formInstance.isValid('primary1', true) || formInstance.isValid('primary3', true);
		    var msg = 'You must correctly fill the mandatory fields.';
		    $(".alert").show();
		    $('.invalid-form-message').html(ok ? '' : msg).toggleClass('filled', !ok);
		    if (!ok){
		      formInstance.validationResult = false;
		    }else{
		    	$(".alert").hide();
		    }
		  });
		});
		function displayVals(area_value) {
		  var area_name = [];
		  area_value = (typeof area_value === 'undefined') ? 'county' : area_value;
		  //var multipleValues = $( "#id_sub_county" ).val() || [];
		  //var multipleValues = $("#id_sub_county option:selected").text() || [];
		  $("#id_"+area_value+" option:selected").each(function () {
			   var $this = $(this);
			   if ($this.length) {
			    var selText = $this.text();
			    area_name.push(selText);
			    //console.log(selText);
			   }
			});

		  $( "#sel_"+area_value ).html(area_name.join( ", " ) );
		}
		$('[data-toggle="tooltip"]').tooltip({'placement': 'bottom'});
		//$( "#id_sub_county" ).change( displayVals );
		$("#id_county").change(function(event) { 
			displayVals();
        });
		$("#id_sub_county").change(function(event) { 
			displayVals("sub_county");
        });
        $("#id_ward").change(function(event) { 
			displayVals("ward");
        });
        displayVals();
        displayVals("sub_county");
		displayVals("ward");
	</script>
{% endblock %}
